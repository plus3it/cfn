{
    "AWSTemplateFormatVersion" : "2010-09-09",
    "Description" : "This template deploys Remote Desktop Session Host (RDSH) instances in an autoscale group behind an ELB, and joins them to a domain.",
    "Parameters" :
    {
        "KeyPairName" :
        {
            "Description" : "Public/private key pairs allow you to securely connect to your instance after it launches",
            "Type" : "AWS::EC2::KeyPair::KeyName"
        },
        "AmiId" :
        {
            "Description" : "(Optional) AMI ID -- will supersede Lambda-based AMI lookup using AmiNameSearchString",
            "Type" : "String",
            "Default" : ""
        },
        "ForceUpdateToggle" :
        {
            "Description" : "A/B toggle that forces a change to a LaunchConfig property, triggering the AutoScale Update Policy",
            "Type" : "String",
            "Default" : "A",
            "AllowedValues" :
            [
                "A",
                "B"
            ]
        },
        "AmiNameSearchString" :
        {
            "Description" : "Search pattern to match against an AMI Name",
            "Type" : "String",
            "Default" : "Windows_Server-2016-English-Full-Base-*"
        },
        "InstanceType" :
        {
            "Description" : "Amazon EC2 instance type for the Remote Desktop Session Instance",
            "Type" : "String",
            "Default" : "t2.medium",
            "AllowedValues" :
            [
                "t2.micro",
                "t2.small",
                "t2.medium",
                "t2.large",
                "t2.xlarge",
                "c4.large",
                "c4.xlarge",
                "m4.large",
                "m4.xlarge",
                "r4.large",
                "r4.xlarge"
            ]
        },
        "DesiredCapacity" :
        {
            "Description" : "The number of instances the autoscale group will spin up initially",
            "Type" : "String",
            "MinLength" : "1",
            "Default" : "1"
        },
        "MinCapacity" :
        {
            "Description" : "The minimum number of instances for the autoscale group",
            "Type" : "String",
            "MinLength" : "1",
            "Default" : "1"
        },
        "MaxCapacity" :
        {
            "Description" : "The maximum number of instances for the autoscale group",
            "Type" : "String",
            "MinLength" : "1",
            "Default" : "2"
        },
        "ScaleUpSchedule" :
        {
            "Description" : "(Optional) Scheduled Action in cron-format (UTC) to scale up to the Desired Capacity; ignored if empty or ScaleDownSchedule is unset (E.g. \"0 10 * * Mon-Fri\")",
            "Type" : "String",
            "Default" : ""
        },
        "ScaleDownSchedule" :
        {
            "Description" : "(Optional) Scheduled Action in cron-format (UTC) to scale down the number of instances; ignored if empty or ScaleUpSchedule is unset (E.g. \"0 0 * * *\")",
            "Type" : "String",
            "Default" : ""
        },
        "ScaleDownDesiredCapacity" :
        {
            "Description" : "(Optional) Desired number of instances during the Scale Down Scheduled Action; ignored if ScaleDownSchedule is unset",
            "Type" : "Number",
            "Default" : "1"
        },
        "LdapContainerOU" :
        {
            "Description" : "DN of the LDAP container or OU in which the RDSH instance will be placed",
            "Type" : "String",
            "Default" : "CN=Users,DC=example,DC=com",
            "MinLength" : "1"
        },
        "DomainAccessUserGroup" :
        {
            "Description" : "Domain group of users authorized to use the RDSH",
            "Type" : "String",
            "Default" : "Domain Users",
            "MinLength" : "1"
        },
        "DomainDirectoryId" :
        {
            "Description" : "ID of the AWS Directory Service domain, e.g. d-xxxxxxxxxx",
            "Type" : "String",
            "AllowedPattern" : "d-[a-zA-Z0-9]{10}"
        },
        "DomainDnsName" :
        {
            "Description" : "Fully qualified domain name (FQDN) of the forest root domain e.g. example.com",
            "Type" : "String",
            "Default" : "example.com",
            "MinLength" : "3",
            "MaxLength" : "25",
            "AllowedPattern" : "[a-zA-Z0-9]+\\..+"
        },
        "DomainNetbiosName" :
        {
            "Description" : "Netbios name of the domain (e.g. EXAMPLE)",
            "Type" : "String",
            "Default" : "EXAMPLE",
            "MinLength" : "1",
            "MaxLength" : "15",
            "AllowedPattern" : "[a-zA-Z0-9]+"
        },
        "DomainSvcAccount" :
        {
            "Description" : "User name for the account that will join the instance to the Connection Broker Cluster",
            "Type" : "String",
            "Default" : "CbSvcAccount",
            "MinLength" : "5",
            "MaxLength" : "25",
            "AllowedPattern" : "[a-zA-Z0-9_-]*"
        },
        "DomainSvcPassword" :
        {
            "Description" : "Password for the Connection Broker service account. Must be at least 8 characters containing letters, numbers and symbols",
            "Type" : "String",
            "MinLength" : "8",
            "MaxLength" : "32",
            "AllowedPattern" : "(?=^.{6,255}$)((?=.*\\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*",
            "NoEcho" : "true",
            "Default" : "Password123"
        },
        "ConnectionBrokerFqdn" :
        {
            "Description" : "Fully qualified domain name (FQDN) of the primary Connection Broker, e.g. \"cb.example.com\"",
            "Type" : "String",
            "Default" : "cb.example.com",
            "MinLength" : "3",
            "AllowedPattern" : "[a-zA-Z0-9_-]+\\..+"
        },
        "UserProfileDiskPath" :
        {
            "Description" : "Path to a CIFS share where User Profile Disks are stored, e.g. \"\\\\home.example.com\\Profiles$\"",
            "Type" : "String",
            "Default" : "\\\\home.example.com\\Profiles$",
            "MinLength" : "3",
            "AllowedPattern" : "^[\\\\\\\\]{2}[a-zA-Z0-9_\\\\-]+\\..+"
        },
        "ExtraSecurityGroupIds" :
        {
            "Description" : "List of extra Security Group IDs to attach to the RDSH instances -- include _at least_ the SG allowing connectivity to the Connection Broker database",
            "Type" : "List<AWS::EC2::SecurityGroup::Id>"
        },
        "SubnetIDs" :
        {
            "Description" : "List of Subnet IDs where the RDSH instances and ELB we be launched",
            "Type" : "List<AWS::EC2::Subnet::Id>"
        },
        "VPC" :
        {
            "Description" : "VPC ID",
            "Type" : "AWS::EC2::VPC::Id"
        }
    },
    "Metadata" :
    {
        "AWS::CloudFormation::Interface" :
        {
            "ParameterGroups" :
            [
                {
                    "Label" :
                    {
                        "default" : "EC2 Instance Configuration"
                    },
                    "Parameters" :
                    [
                        "AmiNameSearchString",
                        "AmiId",
                        "InstanceType",
                        "KeyPairName",
                        "ExtraSecurityGroupIds"
                    ]
                },
                {
                    "Label" :
                    {
                        "default" : "RDSH Application Configuration"
                    },
                    "Parameters" :
                    [
                        "DomainDirectoryId",
                        "DomainDnsName",
                        "DomainNetbiosName",
                        "DomainSvcAccount",
                        "DomainSvcPassword",
                        "DomainAccessUserGroup",
                        "LdapContainerOU",
                        "ConnectionBrokerFqdn",
                        "UserProfileDiskPath"
                    ]
                },
                {
                    "Label" :
                    {
                        "default" : "AutoScale Configuration"
                    },
                    "Parameters" :
                    [
                        "DesiredCapacity",
                        "MinCapacity",
                        "MaxCapacity",
                        "ScaleDownDesiredCapacity",
                        "ScaleDownSchedule",
                        "ScaleUpSchedule",
                        "ForceUpdateToggle"
                    ]
                },
                {   "Label" :
                    {
                        "default" : "Network Configuration"
                    },
                    "Parameters" :
                    [
                        "VPC",
                        "SubnetIDs"
                    ]
                }
            ],
            "ParameterLabels" :
            {
                "AmiNameSearchString" :
                {
                    "default" : "AMI Name Search Pattern"
                },
                "ScaleDownDesiredCapacity" :
                {
                    "default" : "Scale Down Desired Capacity"
                }
            }
        }
    },
    "Conditions" :
    {
        "UseAmiLookup" :
        {
            "Fn::Equals" : [ { "Ref" : "AmiId" }, "" ]
        },
        "UseScheduledAction" :
        {
            "Fn::And" :
            [
                { "Fn::Not" : [ { "Fn::Equals" : [ { "Ref" : "ScaleUpSchedule" }, "" ] } ] },
                { "Fn::Not" : [ { "Fn::Equals" : [ { "Ref" : "ScaleDownSchedule" }, "" ] } ] }
            ]
        }
    },
    "Mappings" :
    {
        "ShellCommandMap" :
        {
            "powershell" :
            {
                "command" : "powershell.exe -NoLogo -NoProfile -NonInteractive -ExecutionPolicy Bypass "
            },
            "cmd" :
            {
                "command" : "cmd.exe /c "
            },
            "psexec" :
            {
                "command" : "c:\\cfn\\files\\pstools\\psexec.exe -accepteula -nobanner -h "
            }
        },
        "InstanceTypeMap" :
        {
            "t2.micro" :
            {
                "HasInstanceVolume" : "false",
                "SupportsEbsOptimized" : "false"
            },
            "t2.small" :
            {
                "HasInstanceVolume" : "false",
                "SupportsEbsOptimized" : "false"
            },
            "t2.medium" :
            {
                "HasInstanceVolume" : "false",
                "SupportsEbsOptimized" : "false"
            },
            "t2.large" :
            {
                "HasInstanceVolume" : "false",
                "SupportsEbsOptimized" : "false"
            },
            "t2.xlarge" :
            {
                "HasInstanceVolume" : "false",
                "SupportsEbsOptimized" : "false"
            },
            "c4.large" :
            {
                "HasInstanceVolume" : "false",
                "SupportsEbsOptimized" : "true"
            },
            "c4.xlarge" :
            {
                "HasInstanceVolume" : "false",
                "SupportsEbsOptimized" : "true"
            },
            "m4.large" :
            {
                "HasInstanceVolume" : "false",
                "SupportsEbsOptimized" : "true"
            },
            "m4.xlarge" :
            {
                "HasInstanceVolume" : "false",
                "SupportsEbsOptimized" : "true"
            },
            "r4.large" :
            {
                "HasInstanceVolume" : "false",
                "SupportsEbsOptimized" : "true"
            },
            "r4.xlarge" :
            {
                "HasInstanceVolume" : "false",
                "SupportsEbsOptimized" : "true"
            }
        }
    },
    "Resources" :
    {
        "AmiIdLookup" :
        {
            "Type" : "Custom::AmiIdLookup",
            "Condition" : "UseAmiLookup",
            "Properties" :
            {
                "ServiceToken" :
                { "Fn::Join" : [ ":", [
                    "arn:aws:lambda",
                    { "Ref" : "AWS::Region" },
                    { "Ref" : "AWS::AccountId" },
                    "function:cfn-look-up-ami-ids"
                ]]},
                "Region" : { "Ref" : "AWS::Region" },
                "AmiNameSearchString" : { "Ref" : "AmiNameSearchString" },
                "ForceUpdateToggle" : { "Ref" : "ForceUpdateToggle" }
            }
        },
        "Ec2IamInstanceProfile" :
        {
            "Type" : "AWS::IAM::InstanceProfile",
            "Properties" :
            {
                "Path" : "/",
                "Roles" : [ { "Ref" : "Ec2IamRole" } ]
            }
        },
        "Ec2IamRole" :
        {
            "Type" : "AWS::IAM::Role",
            "Properties" :
            {
                "AssumeRolePolicyDocument" :
                {
                   "Version" : "2012-10-17",
                   "Statement" :
                   [ {
                      "Effect" : "Allow",
                      "Principal" :
                      {
                         "Service" : [ "ec2.amazonaws.com" ]
                      },
                      "Action" : [ "sts:AssumeRole" ]
                   } ]
                },
                "Path" : "/"
            }
        },
        "Ec2IamRolePolicy" :
        {
            "Type" : "AWS::IAM::Policy",
            "Properties" :
            {
                "PolicyName" :
                { "Fn::Join" : [ "", [
                    "ra-rdsh-",
                    { "Ref" : "AWS::StackName" }
                ]]},
                "PolicyDocument" :
                {
                    "Version" : "2012-10-17",
                    "Statement" :
                    [
                        {
                            "Effect" : "Allow",
                            "Action" :
                            [
                                "ssm:DescribeAssociation",
                                "ssm:GetDeployablePatchSnapshotForInstance",
                                "ssm:GetDocument",
                                "ssm:ListAssociations",
                                "ssm:ListInstanceAssociations",
                                "ssm:PutInventory",
                                "ssm:UpdateAssociationStatus",
                                "ssm:UpdateInstanceAssociationStatus",
                                "ssm:UpdateInstanceInformation"
                            ],
                            "Resource" : "*"
                        },
                        {
                            "Effect" : "Allow",
                            "Action" :
                            [
                                "ec2messages:AcknowledgeMessage",
                                "ec2messages:DeleteMessage",
                                "ec2messages:FailMessage",
                                "ec2messages:GetEndpoint",
                                "ec2messages:GetMessages",
                                "ec2messages:SendReply"
                            ],
                            "Resource" : "*"
                        },
                        {
                            "Effect" : "Allow",
                            "Action" :
                            [
                                "cloudwatch:PutMetricData"
                            ],
                            "Resource" : "*"
                        },
                        {
                            "Effect" : "Allow",
                            "Action" :
                            [
                                "ec2:DescribeInstanceStatus"
                            ],
                            "Resource" : "*"
                        },
                        {
                            "Effect" : "Allow",
                            "Action" :
                            [
                                "ds:CreateComputer",
                                "ds:DescribeDirectories"
                            ],
                            "Resource" : "*"
                        },
                        {
                            "Effect" : "Allow",
                            "Action" :
                            [
                                "logs:CreateLogGroup",
                                "logs:CreateLogStream",
                                "logs:DescribeLogGroups",
                                "logs:DescribeLogStreams",
                                "logs:PutLogEvents"
                            ],
                            "Resource" : "*"
                        },
                        {
                            "Effect" : "Allow",
                            "Action" :
                            [
                                "s3:ListBucket"
                            ],
                            "Resource" : "arn:aws:s3:::amazon-ssm-packages-*"
                        }
                    ]
                },
                "Roles" : [ { "Ref" : "Ec2IamRole" } ]
            }
        },
        "SsmAssociation" :
        {
            "Type" : "AWS::SSM::Association",
            "Properties" :
            {
                "Name" : "AWS-JoinDirectoryServiceDomain",
                "Parameters" :
                {
                    "directoryId" : [ { "Ref" : "DomainDirectoryId" } ],
                    "directoryName" : [ { "Ref" : "DomainDnsName" } ],
                    "directoryOU" : [ { "Ref" : "LdapContainerOU" } ]
                },
                "Targets" :
                [ {
                    "Key" : "tag:aws:cloudformation:stack-id",
                    "Values" : [ { "Ref" : "AWS::StackId" } ]
                } ]
            }
        },
        "ScaleUpScheduledAction" :
        {
            "Type" : "AWS::AutoScaling::ScheduledAction",
            "Condition" : "UseScheduledAction",
            "Properties" :
            {
                "AutoScalingGroupName" : { "Ref" : "AutoScalingGroup" },
                "DesiredCapacity" : { "Ref" : "DesiredCapacity" },
                "Recurrence" : { "Ref" : "ScaleUpSchedule" }
            }
        },
        "ScaleDownScheduledAction" :
        {
            "Type" : "AWS::AutoScaling::ScheduledAction",
            "Condition" : "UseScheduledAction",
            "Properties" :
            {
                "AutoScalingGroupName" : { "Ref" : "AutoScalingGroup" },
                "DesiredCapacity" : { "Ref" : "ScaleDownDesiredCapacity" },
                "Recurrence" : { "Ref" : "ScaleDownSchedule" }
            }
        },
        "Ec2SecurityGroup" :
        {
            "Type" : "AWS::EC2::SecurityGroup",
            "Properties" :
            {
                "GroupDescription" : "Allow Remote Access to the RDSH instances",
                "VpcId" : { "Ref" : "VPC" },
                "Tags" :
                [
                    {
                        "Key" : "Name",
                        "Value" : { "Fn::Join" : [ "", [
                            "ra-rdsh-ec2-",
                            { "Ref" : "AWS::StackName" }
                        ]]}
                    }
                ]
            }
        },
        "ElbToRdshIngressTcp3389" :
        {
            "Type" : "AWS::EC2::SecurityGroupIngress",
            "Properties" :
            {
                "GroupId" : { "Ref" : "Ec2SecurityGroup" },
                "IpProtocol" : "tcp",
                "FromPort" : "3389",
                "ToPort" : "3389",
                "SourceSecurityGroupId" : { "Ref" : "ElbSecurityGroup" }
            }
        },
        "ElbSecurityGroup" :
        {
            "Type" : "AWS::EC2::SecurityGroup",
            "Properties" :
            {
                "GroupDescription" : "Allow connectivity through the RDSH ELB to RDSH instances",
                "VpcId" : { "Ref" : "VPC" },
                "Tags" :
                [
                    {
                        "Key" : "Name",
                        "Value" : { "Fn::Join" : ["", [
                            "ra-rdsh-elb-",
                            { "Ref" : "AWS::StackName" }
                        ]]}
                    }
                ]
            }
        },
        "PublicToElbIngressTcp3389" :
        {
            "Type" : "AWS::EC2::SecurityGroupIngress",
            "Properties" :
            {
                "GroupId" : { "Ref" : "ElbSecurityGroup" },
                "IpProtocol" : "tcp",
                "FromPort" : "3389",
                "ToPort" : "3389",
                "CidrIp" : "0.0.0.0/0"
            }
        },
        "ElbToRdshEgressTcp3389" :
        {
            "Type" : "AWS::EC2::SecurityGroupEgress",
            "Properties" :
            {
                "GroupId" : { "Ref" : "ElbSecurityGroup" },
                "IpProtocol" : "tcp",
                "FromPort" : "3389",
                "ToPort" : "3389",
                "DestinationSecurityGroupId" : { "Ref" : "Ec2SecurityGroup" }
            }
        },
        "ELB" :
        {
            "Type" : "AWS::ElasticLoadBalancing::LoadBalancer",
            "Properties":
            {
                "CrossZone" : "false",
                "HealthCheck" :
                {
                    "HealthyThreshold" : "5",
                    "Interval" : "60",
                    "Target" : "TCP:3389",
                    "Timeout" : "5",
                    "UnhealthyThreshold" : "10"
                },
                "ConnectionSettings" :
                {
                    "IdleTimeout" : "900"
                },
                "ConnectionDrainingPolicy" :
                {
                    "Enabled" : "true",
                    "Timeout" : "1800"
                },
                "Listeners" :
                [
                    {
                        "InstancePort" : "3389",
                        "InstanceProtocol" : "TCP",
                        "LoadBalancerPort" : "3389",
                        "Protocol" : "TCP"
                    }
                ],
                "Policies" : [],
                "Scheme" : "internal",
                "SecurityGroups" : [ { "Ref" : "ElbSecurityGroup" } ],
                "Subnets" : { "Ref" : "SubnetIDs" },
                "Tags" :
                [
                    {
                        "Key" : "Name",
                        "Value" : { "Ref" : "AWS::StackName" }
                    }
                ]
            }
        },
        "AutoScalingGroup" :
        {
            "Type" : "AWS::AutoScaling::AutoScalingGroup",
            "CreationPolicy" :
            {
                "ResourceSignal" :
                {
                    "Count" : { "Ref" : "DesiredCapacity" },
                    "Timeout" : "PT60M"
                }
            },
            "UpdatePolicy" :
            {
                "AutoScalingRollingUpdate" :
                {
                    "MinInstancesInService" : { "Ref" : "MinCapacity" },
                    "MaxBatchSize" : { "Ref" : "MaxCapacity" },
                    "WaitOnResourceSignals" : "true",
                    "PauseTime" : "PT60M",
                    "SuspendProcesses" : [ "ScheduledActions" ]
                },
                "AutoScalingScheduledAction" :
                {
                    "IgnoreUnmodifiedGroupSizeProperties" : "true"
                }
            },
            "Properties" :
            {
                "VPCZoneIdentifier" : { "Ref" : "SubnetIDs" },
                "LaunchConfigurationName" : { "Ref" : "LaunchConfig" },
                "LoadBalancerNames" : [ { "Ref" : "ELB" } ],
                "MinSize" : { "Ref" : "MinCapacity" },
                "MaxSize" : { "Ref" : "MaxCapacity" },
                "DesiredCapacity" : { "Ref" : "DesiredCapacity" },
                "HealthCheckGracePeriod" : "3600",
                "HealthCheckType" : "ELB",
                "MetricsCollection" : [ { "Granularity" : "1Minute" } ],
                "Tags" :
                [
                    {
                        "Key" : "Name",
                        "Value" : { "Ref" : "AWS::StackName" },
                        "PropagateAtLaunch" : "true"
                    }
                ]
            }
        },
        "LaunchConfig" :
        {
            "Type" : "AWS::AutoScaling::LaunchConfiguration",
            "Metadata" :
            {
                "AWS::CloudFormation::Init" :
                {
                    "configSets" :
                    {
                        "config" :
                        [
                            "join-domain",
                            "setup",
                            "installRDS",
                            "finalize"
                        ],
                        "update" :
                        [
                            "setup",
                            "finalize"
                        ]
                    },
                    "setup" :
                    {
                        "files" :
                        {
                            "c:\\cfn\\cfn-hup.conf" :
                            {
                                "content" :
                                { "Fn::Join" : [ "", [
                                    "[main]\n",
                                    "stack=", { "Ref" : "AWS::StackName" },
                                    "\n",
                                    "region=", { "Ref" : "AWS::Region" },
                                    "\n"
                                ]]}
                            },
                            "c:\\cfn\\hooks.d\\cfn-auto-reloader.conf" :
                            {
                                "content" :
                                { "Fn::Join" : [ "", [
                                    "[cfn-auto-reloader-hook]\n",
                                    "triggers=post.update\n",
                                    "path=Resources.LaunchConfig.Metadata.AWS::CloudFormation::Init\n",
                                    "action=cfn-init.exe -v -c update",
                                    " --stack ", { "Ref" : "AWS::StackName" },
                                    " --resource LaunchConfig ",
                                    " --region ", { "Ref" : "AWS::Region"}, "\n"
                                ]]}
                            },
                            "c:\\cfn\\scripts\\configure-rdsh.ps1" :
                            {
                                "source" : "https://raw.githubusercontent.com/lorengordon/cfn/rdsh-cb/scripts/configure-rdsh.ps1"
                            },
                            "c:\\cfn\\scripts\\unzip-archive.ps1" :
                            {
                                "source" : "https://raw.githubusercontent.com/plus3it/cfn/master/scripts/unzip-archive.ps1"
                            },
                            "c:\\cfn\\files\\pstools.zip" :
                            {
                                "source" : "https://download.sysinternals.com/files/PSTools.zip"
                            }
                        },
                        "services" :
                        {
                            "windows" :
                            {
                                "cfn-hup" :
                                {
                                    "enabled" : "true",
                                    "ensureRunning" : "true",
                                    "files" :
                                    [
                                        "c:\\cfn\\cfn-hup.conf",
                                        "c:\\cfn\\hooks.d\\cfn-auto-reloader.conf"
                                    ]
                                }
                            }
                        },
                        "commands" :
                        {
                            "a-unzip-pstools" :
                            {
                                "command" : "powershell.exe c:\\cfn\\scripts\\unzip-archive.ps1 c:\\cfn\\files\\pstools.zip c:\\cfn\\files\\pstools",
                                "waitAfterCompletion" : "0"
                            },
                            "b-set-cfn-permissions" :
                            {
                                "command" :
                                { "Fn::Join" : [ "", [
                                    { "Fn::FindInMap" :
                                        [
                                            "ShellCommandMap",
                                            "powershell",
                                            "command"
                                        ]
                                    },
                                    "-Command ",
                                    "\"",
                                    "Invoke-Command -ScriptBlock { ",
                                    "$Folder = 'C:\\cfn'; ",
                                    "$Acl = Get-Acl $Folder; ",
                                    "$Acl.SetAccessRuleProtection($True, $False); ",
                                    "$Rule = New-Object System.Security.AccessControl.FileSystemAccessRule('SYSTEM', 'FullControl', 'ContainerInherit, ObjectInherit', 'None', 'Allow'); ",
                                    "$Acl.AddAccessRule($Rule); ",
                                    "$Rule = New-Object System.Security.AccessControl.FileSystemAccessRule('Administrators', 'FullControl', 'ContainerInherit, ObjectInherit', 'None', 'Allow'); ",
                                    "$Acl.AddAccessRule($Rule); ",
                                    "$Rule = New-Object System.Security.AccessControl.FileSystemAccessRule('CREATOR OWNER', 'FullControl', 'ContainerInherit, ObjectInherit', 'InheritOnly', 'Allow'); ",
                                    "$Acl.AddAccessRule($Rule); ",
                                    "Set-Acl $Folder $Acl -ErrorAction Stop; ",
                                    "}",
                                    "\""
                                ] ] },
                                "waitAfterCompletion" : "0"
                            }
                        }
                    },
                    "join-domain" :
                    {
                        "commands" :
                        {
                            "10-join-domain" :
                            {
                                "command" :
                                { "Fn::Join" : [ "", [
                                    { "Fn::FindInMap" :
                                        [
                                            "ShellCommandMap",
                                            "powershell",
                                            "command"
                                        ]
                                    },
                                    "-Command ",
                                    "Write-Verbose 'Waiting for SSM to complete domain join, which reboots the instance automatically' -Verbose"
                                ] ] },
                                "waitAfterCompletion" : "forever"
                            }
                        }
                    },
                    "installRDS" :
                    {
                        "commands" :
                        {
                            "10-install-rds" :
                            {
                                "command" : "powershell.exe \"Install-WindowsFeature RDS-RD-Server,RDS-Licensing,Search-Service,RSAT-ADDS-Tools,GPMC -Verbose\"",
                                "waitAfterCompletion" : "0"
                            },
                            "15-reboot-rds" :
                            {
                                "command" : "powershell.exe \"Restart-Computer -Force -Verbose\"",
                                "waitAfterCompletion" : "forever"
                            },
                            "20-configure-admins" :
                            {
                                "command" :
                                { "Fn::Join" : [ "", [
                                    { "Fn::FindInMap" :
                                        [
                                            "ShellCommandMap",
                                            "powershell",
                                            "command"
                                        ]
                                    },
                                    "-Command \"",
                                    "Invoke-Command -ScriptBlock {",
                                    "$ErrorActionPreference = 'Stop'; ",
                                    "Import-Module RemoteDesktop,RemoteDesktopServices; ",
                                    "if (-not ('", { "Ref" : "DomainSvcAccount" }, "' -in [Microsoft.TerminalServices.PSEngine.UserGroupHelper]::ListMembers('Administrators'))) { ",
                                    "[Microsoft.TerminalServices.PSEngine.UserGroupHelper]::AddMember('Administrators', '", { "Ref" : "DomainSvcAccount" }, "'); ",
                                    "} } -Verbose -ErrorAction Stop",
                                    "\""
                                ] ] },
                                "waitAfterCompletion" : "0"
                            },
                            "30-configure-rdsh" :
                            {
                                "command" :
                                { "Fn::Join" : [ "", [
                                    { "Fn::FindInMap" :
                                        [
                                            "ShellCommandMap",
                                            "psexec",
                                            "command"
                                        ]
                                    },
                                    "-u \"",
                                    { "Ref" : "DomainNetbiosName" }, "\\",
                                    { "Ref" : "DomainSvcAccount" },
                                    "\" -p \"",
                                    { "Ref" : "DomainSvcPassword" },
                                    "\" ",
                                    { "Fn::FindInMap" :
                                        [
                                            "ShellCommandMap",
                                            "powershell",
                                            "command"
                                        ]
                                    },
                                    " c:\\cfn\\scripts\\configure-rdsh.ps1 ",
                                    "-DomainNetBiosName '",
                                    { "Ref" : "DomainNetbiosName" },
                                    "' -GroupName '",
                                    { "Ref" : "DomainAccessUserGroup" },
                                    "' -ConnectionBroker '",
                                    { "Ref" : "ConnectionBrokerFqdn" },
                                    "' -UpdPath '",
                                    { "Ref" : "UserProfileDiskPath" },
                                    "' -Verbose -ErrorAction Stop"
                                ]]},
                                "waitAfterCompletion" : "0"
                            },
                            "40-reboot-rds" :
                            {
                                "command" : "powershell.exe \"Restart-Computer -Force -Verbose\"",
                                "waitAfterCompletion" : "forever"
                            }
                        }
                    },
                    "finalize" :
                    {
                        "commands" :
                        {
                            "10-signal-success" :
                            {
                                "command" :
                                { "Fn::Join" : [ "", [
                                    "cfn-signal.exe -e 0",
                                    " --stack ", { "Ref" : "AWS::StackName" },
                                    " --resource AutoScalingGroup ",
                                    " --region ", { "Ref" : "AWS::Region"}
                                ]]},
                                "ignoreErrors" : "true",
                                "waitAfterCompletion" : "0"
                            }
                        }
                    }
                }
            },
            "Properties" :
            {
                "ImageId" :
                {
                    "Fn::If" :
                    [
                        "UseAmiLookup",
                        {"Fn::GetAtt" : [ "AmiIdLookup", "Id" ]},
                        {"Ref" : "AmiId"}
                    ]
                },
                "InstanceType" : { "Ref" : "InstanceType" },
                "KeyName" : { "Ref" : "KeyPairName" },
                "IamInstanceProfile" : { "Ref" : "Ec2IamInstanceProfile" },
                "EbsOptimized" :
                {
                    "Fn::FindInMap" :
                    [
                        "InstanceTypeMap",
                        { "Ref" : "InstanceType" },
                        "SupportsEbsOptimized"
                    ]
                },
                "BlockDeviceMappings" :
                [
                    {
                        "DeviceName" : "/dev/sda1",
                        "Ebs" :
                        {
                            "VolumeSize" : "50",
                            "VolumeType" : "gp2",
                            "DeleteOnTermination" : "true"
                        }
                    }
                ],
                "SecurityGroups" :
                { "Fn::Split" : [ ",",
                    { "Fn::Join" : [ ",", [
                        { "Ref" : "Ec2SecurityGroup" },
                        { "Fn::Join" : [ ",",
                            { "Ref" : "ExtraSecurityGroupIds" }
                        ]}
                    ]]}
                ]},
                "UserData" :
                { "Fn::Base64" : { "Fn::Join" : [ "", [
                    "<script>\n",
                    "REM CFN LaunchConfig Update Toggle: ",
                    { "Ref" : "ForceUpdateToggle" },
                    "\n",
                    "cfn-init.exe -v -c config",
                    " --stack ", { "Ref" : "AWS::StackName" },
                    " --resource LaunchConfig ",
                    " --region ", { "Ref" : "AWS::Region"}, "\n",
                    "</script>\n"
                ]]}}
            }
        }
    },
    "Outputs" :
    {
        "LoadBalancerName" :
        {
            "Description" : "Name of the Elastic Load Balancer",
            "Value" : { "Ref" : "ELB" }
        },
        "LoadBalancerDns" :
        {
            "Description" : "DNS name for the ELB",
            "Value" : { "Fn::GetAtt" : [ "ELB", "DNSName" ] }
        },
        "Ec2SecurityGroupId" :
        {
            "Value" : { "Ref" : "Ec2SecurityGroup" },
            "Description" : "Security Group ID for RDSH EC2 instances"
        },
        "ElbSecurityGroupId" :
        {
            "Value" : { "Ref" : "ElbSecurityGroup" },
            "Description" : "Security Group ID for the RDSH Elastic Load Balancer"
        }
    }
}
